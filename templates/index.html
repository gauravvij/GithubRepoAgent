<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CodeScope â€” Codebase Analysis Agent</title>
<style>
/* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:          #0d1117;
  --bg-terminal: #0d1117;
  --bg-header:   #161b22;
  --bg-input:    #0d1117;
  --bg-report:   #0d1117;
  --border:      #30363d;
  --green:       #39d353;
  --green-dim:   #238636;
  --cyan:        #58a6ff;
  --yellow:      #e3b341;
  --red:         #f85149;
  --white:       #c9d1d9;
  --dim:         #6e7681;
  --prompt:      #39d353;
  --font:        'Cascadia Code', 'Fira Code', 'JetBrains Mono', 'Courier New', monospace;
  --radius:      6px;
}

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--white);
  font-family: var(--font);
  font-size: 14px;
  line-height: 1.6;
}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.wrapper {
  display: flex;
  flex-direction: column;
  height: 100vh;
  max-width: 1100px;
  margin: 0 auto;
  padding: 16px;
  gap: 12px;
}

/* â”€â”€ Window chrome â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.terminal-window {
  display: flex;
  flex-direction: column;
  flex: 1;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  background: var(--bg-terminal);
  box-shadow: 0 8px 32px rgba(0,0,0,0.6);
}

.title-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: var(--bg-header);
  border-bottom: 1px solid var(--border);
  user-select: none;
}

.dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
.dot-red    { background: #ff5f57; }
.dot-yellow { background: #febc2e; }
.dot-green  { background: #28c840; }

.title-text {
  flex: 1;
  text-align: center;
  font-size: 12px;
  color: var(--dim);
  letter-spacing: 0.05em;
}

/* â”€â”€ Restart button in title bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-restart {
  display: none;
  align-items: center;
  gap: 5px;
  background: transparent;
  color: var(--yellow);
  border: 1px solid var(--yellow);
  border-radius: var(--radius);
  padding: 2px 10px;
  font-family: var(--font);
  font-size: 11px;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
  flex-shrink: 0;
}
.btn-restart:hover { background: var(--yellow); color: #000; }
.btn-restart.visible { display: flex; }

/* â”€â”€ Output area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#output {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px;
  font-size: 13px;
  line-height: 1.7;
  scroll-behavior: smooth;
}

#output::-webkit-scrollbar { width: 6px; }
#output::-webkit-scrollbar-track { background: transparent; }
#output::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* â”€â”€ Line types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.line { display: block; white-space: pre-wrap; word-break: break-word; }
.line + .line { margin-top: 1px; }

.line-banner   { color: var(--green); font-weight: bold; }
.line-prompt   { color: var(--prompt); }
.line-status   { color: var(--cyan); }
.line-report   { color: var(--white); }
.line-answer   { color: var(--white); }
.line-error    { color: var(--red); }
.line-dim      { color: var(--dim); }
.line-sep      { color: var(--border); }
.line-question { color: var(--yellow); }
.line-label    { color: var(--green-dim); }

/* Markdown-like rendering inside report/answer blocks */
.md-h3    { color: var(--cyan); font-weight: bold; margin-top: 8px; }
.md-bold  { color: var(--yellow); font-weight: bold; }
.md-code  { color: var(--green); background: #161b22; padding: 0 4px; border-radius: 3px; }
.md-li    { color: var(--white); padding-left: 16px; }

/* â”€â”€ Collapsible Report Block â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.report-block {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin: 8px 0;
  overflow: hidden;
}

.report-toggle-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 14px;
  background: var(--bg-header);
  cursor: pointer;
  user-select: none;
  border-bottom: 1px solid transparent;
  transition: background 0.15s;
}
.report-toggle-bar:hover { background: #1c2128; }
.report-toggle-bar.open  { border-bottom-color: var(--border); }

.report-toggle-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  font-weight: bold;
  color: var(--green);
  letter-spacing: 0.04em;
}
.report-toggle-label .icon { font-size: 14px; }

.report-toggle-hint {
  font-size: 11px;
  color: var(--dim);
}

.report-toggle-arrow {
  font-size: 11px;
  color: var(--cyan);
  transition: transform 0.2s;
  margin-left: 8px;
}
.report-toggle-bar.open .report-toggle-arrow { transform: rotate(180deg); }

.report-content {
  display: none;
  padding: 12px 16px;
  background: var(--bg-report);
  font-size: 13px;
  line-height: 1.7;
}
.report-content.open { display: block; }

/* â”€â”€ Blinking cursor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cursor {
  display: inline-block;
  width: 8px;
  height: 14px;
  background: var(--green);
  vertical-align: middle;
  animation: blink 1s step-end infinite;
  margin-left: 2px;
}
@keyframes blink { 50% { opacity: 0; } }

/* â”€â”€ Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.spin-chars::after {
  content: 'â ‹';
  animation: spinchars 0.8s steps(8) infinite;
}
@keyframes spinchars {
  0%   { content: 'â ‹'; }
  12%  { content: 'â ™'; }
  25%  { content: 'â ¹'; }
  37%  { content: 'â ¸'; }
  50%  { content: 'â ¼'; }
  62%  { content: 'â ´'; }
  75%  { content: 'â ¦'; }
  87%  { content: 'â §'; }
  100% { content: 'â ‡'; }
}

/* â”€â”€ Input row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.input-row {
  display: flex;
  align-items: center;
  gap: 0;
  padding: 10px 20px;
  border-top: 1px solid var(--border);
  background: var(--bg-input);
}

.input-prompt {
  color: var(--prompt);
  font-family: var(--font);
  font-size: 13px;
  white-space: nowrap;
  flex-shrink: 0;
  padding-right: 8px;
}

#cmd-input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: var(--white);
  font-family: var(--font);
  font-size: 13px;
  caret-color: var(--green);
}

#cmd-input::placeholder { color: var(--dim); }
#cmd-input:disabled { opacity: 0.4; cursor: not-allowed; }

.btn-submit {
  background: var(--green-dim);
  color: #fff;
  border: none;
  border-radius: var(--radius);
  padding: 4px 14px;
  font-family: var(--font);
  font-size: 12px;
  cursor: pointer;
  transition: background 0.2s;
  flex-shrink: 0;
  margin-left: 8px;
}
.btn-submit:hover  { background: var(--green); color: #000; }
.btn-submit:disabled { opacity: 0.4; cursor: not-allowed; }

/* â”€â”€ Status bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.status-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 20px;
  font-size: 11px;
  color: var(--dim);
  border-top: 1px solid var(--border);
  background: var(--bg-header);
}

.status-dot {
  display: inline-block;
  width: 7px; height: 7px;
  border-radius: 50%;
  margin-right: 5px;
  background: var(--dim);
}
.status-dot.ready   { background: var(--green); }
.status-dot.working { background: var(--yellow); animation: blink 0.6s step-end infinite; }
.status-dot.error   { background: var(--red); }

/* â”€â”€ Error hint box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.error-hint {
display: flex;
align-items: flex-start;
gap: 8px;
margin: 4px 0;
padding: 8px 12px;
border-left: 3px solid var(--red);
background: rgba(248, 81, 73, 0.07);
border-radius: 0 var(--radius) var(--radius) 0;
}
.error-hint-icon { color: var(--red); flex-shrink: 0; }
.error-hint-text { color: var(--red); font-size: 12px; line-height: 1.5; }

/* â”€â”€ Pipeline Progress Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pipeline-panel {
border: 1px solid var(--border);
border-radius: var(--radius);
margin: 8px 0;
overflow: hidden;
background: #0d1117;
}

.pipeline-header {
display: flex;
align-items: center;
gap: 8px;
padding: 7px 14px;
background: var(--bg-header);
border-bottom: 1px solid var(--border);
font-size: 11px;
font-weight: bold;
color: var(--cyan);
letter-spacing: 0.06em;
user-select: none;
}

.pipeline-header .ph-icon { font-size: 13px; }

.pipeline-stages {
display: flex;
flex-direction: column;
gap: 0;
padding: 6px 0;
}

.pipeline-stage {
display: flex;
align-items: center;
gap: 10px;
padding: 5px 14px;
font-size: 12px;
transition: background 0.15s;
}

.pipeline-stage.active  { background: rgba(88, 166, 255, 0.06); }
.pipeline-stage.done    { background: transparent; }
.pipeline-stage.pending { opacity: 0.35; }

.stage-icon {
width: 18px;
text-align: center;
flex-shrink: 0;
font-size: 13px;
}

.stage-icon.spin { animation: rotateSpin 1s linear infinite; display: inline-block; }
@keyframes rotateSpin { to { transform: rotate(360deg); } }

.stage-label {
flex: 1;
color: var(--white);
}
.pipeline-stage.pending .stage-label { color: var(--dim); }
.pipeline-stage.active  .stage-label { color: var(--cyan); }
.pipeline-stage.done    .stage-label { color: var(--green); }

.stage-detail {
font-size: 11px;
color: var(--dim);
text-align: right;
min-width: 80px;
}
.pipeline-stage.active .stage-detail { color: var(--yellow); }
.pipeline-stage.done   .stage-detail { color: var(--green-dim); }

/* Progress bar inside stage */
.stage-bar-wrap {
width: 80px;
height: 4px;
background: #21262d;
border-radius: 2px;
overflow: hidden;
flex-shrink: 0;
}
.stage-bar {
height: 100%;
background: var(--cyan);
border-radius: 2px;
transition: width 0.3s ease;
}
.pipeline-stage.done .stage-bar { background: var(--green); }

/* â”€â”€ NEO Branding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.neo-tag {
position: fixed;
bottom: 18px;
right: 20px;
z-index: 9999;
display: flex;
align-items: center;
gap: 6px;
text-decoration: none;
color: var(--dim);
font-family: var(--font);
font-size: 11px;
letter-spacing: 0.06em;
padding: 5px 10px;
border: 1px solid #21262d;
border-radius: 20px;
background: rgba(13, 17, 23, 0.85);
backdrop-filter: blur(6px);
-webkit-backdrop-filter: blur(6px);
transition: color 0.2s, border-color 0.2s, background 0.2s;
user-select: none;
}
.neo-tag:hover {
color: var(--white);
border-color: var(--border);
background: rgba(22, 27, 34, 0.95);
}
.neo-tag .neo-dot {
width: 6px;
height: 6px;
border-radius: 50%;
background: var(--green);
flex-shrink: 0;
}
</style>
</head>
<body>
<div class="wrapper">
  <div class="terminal-window">

    <!-- Title bar -->
    <div class="title-bar">
      <span class="dot dot-red"></span>
      <span class="dot dot-yellow"></span>
      <span class="dot dot-green"></span>
      <span class="title-text">codescope â€” codebase analysis agent  ~/terminal</span>
      <button class="btn-restart" id="btn-restart" title="Start over with a new GitHub URL">
        â†º New Repo
      </button>
    </div>

    <!-- Output -->
    <div id="output"></div>

    <!-- Input row -->
    <div class="input-row">
      <span class="input-prompt" id="prompt-label">codescope $&nbsp;</span>
      <input
        id="cmd-input"
        type="text"
        autocomplete="off"
        autocorrect="off"
        spellcheck="false"
        placeholder="Enter a GitHub URL to beginâ€¦"
      />
      <button class="btn-submit" id="btn-submit">Enter</button>
    </div>

    <!-- Status bar -->
    <div class="status-bar">
      <span><span class="status-dot" id="status-dot"></span><span id="status-text">Ready</span></span>
      <span id="session-label">No session</span>
      <span id="model-label">model: loadingâ€¦</span>
    </div>

  </div>
</div>

<!-- NEO Branding -->
<a class="neo-tag" href="https://heyneo.so/" target="_blank" rel="noopener noreferrer">
  <span class="neo-dot"></span>Made by NEO
</a>

<script>
/* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const state = {
  sessionId:  null,
  hasReport:  false,
  busy:       false,
  history:    [],
  historyIdx: -1,
};

/* â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const output       = document.getElementById('output');
const cmdInput     = document.getElementById('cmd-input');
const btnSubmit    = document.getElementById('btn-submit');
const btnRestart   = document.getElementById('btn-restart');
const statusDot    = document.getElementById('status-dot');
const statusText   = document.getElementById('status-text');
const sessionLabel = document.getElementById('session-label');
const promptLabel  = document.getElementById('prompt-label');

/* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function scrollBottom() {
  output.scrollTop = output.scrollHeight;
}

function setStatus(stateName, text) {
  statusDot.className = 'status-dot ' + stateName;
  statusText.textContent = text;
}

function setSession(id) {
  state.sessionId = id;
  sessionLabel.textContent = id ? 'session: ' + id.slice(0, 8) + 'â€¦' : 'No session';
}

function setBusy(busy) {
  state.busy = busy;
  cmdInput.disabled = busy;
  btnSubmit.disabled = busy;
  btnRestart.disabled = busy;
  if (!busy) cmdInput.focus();
}

function showRestartButton(visible) {
  if (visible) {
    btnRestart.classList.add('visible');
  } else {
    btnRestart.classList.remove('visible');
  }
}

/** Append a plain text line to the terminal output */
function appendLine(text, cls = 'line-dim') {
  const span = document.createElement('span');
  span.className = 'line ' + cls;
  span.textContent = text;
  output.appendChild(span);
  scrollBottom();
  return span;
}

/** Append a blank separator line */
function appendBlank() { appendLine('', 'line-dim'); }

/** Remove a specific element (used to clear spinner lines) */
function removeLine(el) { if (el && el.parentNode) el.parentNode.removeChild(el); }

/**
 * Append a styled error hint box with icon and message.
 * @param {string} message - Human-readable error description.
 */
function appendErrorHint(message) {
  const wrapper = document.createElement('div');
  wrapper.className = 'error-hint';

  const icon = document.createElement('span');
  icon.className = 'error-hint-icon';
  icon.textContent = 'âœ–';

  const text = document.createElement('span');
  text.className = 'error-hint-text';
  text.textContent = message;

  wrapper.appendChild(icon);
  wrapper.appendChild(text);
  output.appendChild(wrapper);
  scrollBottom();
}

/**
 * Render markdown-ish text into the terminal.
 * Handles ### headings, **bold**, `code`, and - list items.
 * @param {string} text - Markdown text to render.
 * @param {string} baseClass - CSS class for plain lines.
 * @param {HTMLElement|null} container - Target container (defaults to #output).
 */
function renderMarkdown(text, baseClass, container) {
  const target = container || output;
  const lines = text.split('\n');
  lines.forEach(raw => {
    const span = document.createElement('span');
    span.className = 'line ' + baseClass;

    if (/^###\s/.test(raw)) {
      span.className = 'line md-h3';
      span.textContent = raw.replace(/^###\s*/, 'â–¸ ');
    } else if (/^##\s/.test(raw)) {
      span.className = 'line md-h3';
      span.textContent = raw.replace(/^##\s*/, 'â–¶ ');
    } else if (/^#\s/.test(raw)) {
      span.className = 'line md-h3';
      span.textContent = raw.replace(/^#\s*/, 'â—† ');
    } else if (/^[-*]\s/.test(raw)) {
      span.className = 'line md-li';
      span.textContent = '  â€¢ ' + raw.replace(/^[-*]\s*/, '');
    } else if (/^---+$/.test(raw.trim())) {
      span.className = 'line line-sep';
      span.textContent = 'â”€'.repeat(60);
    } else {
      // Inline: **bold** and `code`
      span.innerHTML = raw
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/\*\*(.+?)\*\*/g, '<span class="md-bold">$1</span>')
        .replace(/`([^`]+)`/g, '<span class="md-code">$1</span>');
    }

    target.appendChild(span);
  });
  if (target === output) scrollBottom();
}

/**
 * Build and insert a collapsible report block into #output.
 * The report content is hidden by default; clicking the header toggles it.
 * @param {string} reportText - Full markdown report text.
 */
function appendCollapsibleReport(reportText) {
  // Outer wrapper
  const block = document.createElement('div');
  block.className = 'report-block';

  // Toggle header bar
  const bar = document.createElement('div');
  bar.className = 'report-toggle-bar';
  bar.innerHTML = `
    <span class="report-toggle-label">
      <span class="icon">ðŸ“‹</span>
      CODEBASE ANALYSIS REPORT
      <span class="report-toggle-hint">(click to expand)</span>
    </span>
    <span class="report-toggle-arrow">â–¼</span>
  `;

  // Content area (hidden by default)
  const content = document.createElement('div');
  content.className = 'report-content';

  // Render markdown into content div
  renderMarkdown(reportText, 'line-report', content);

  // Toggle logic
  bar.addEventListener('click', () => {
    const isOpen = content.classList.contains('open');
    if (isOpen) {
      content.classList.remove('open');
      bar.classList.remove('open');
      bar.querySelector('.report-toggle-hint').textContent = '(click to expand)';
    } else {
      content.classList.add('open');
      bar.classList.add('open');
      bar.querySelector('.report-toggle-hint').textContent = '(click to collapse)';
      scrollBottom();
    }
  });

  block.appendChild(bar);
  block.appendChild(content);
  output.appendChild(block);
  scrollBottom();
}

/* â”€â”€ Boot banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function printBanner(modelName) {
  // Build the "Powered by" line dynamically from the active model in .env
  const displayModel = modelName || 'OpenRouter';
  // Pad the model line to fit the banner width (64 chars between â•‘ borders)
  const innerWidth = 64;
  const label = 'Powered by ' + displayModel + ' / OpenRouter';
  const padTotal = innerWidth - label.length;
  const padLeft = Math.floor(padTotal / 2);
  const padRight = padTotal - padLeft;
  const modelLine = 'â•‘' + ' '.repeat(padLeft) + label + ' '.repeat(padRight) + 'â•‘';

  const banner = [
    'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—',
    'â•‘          C O D E S C O P E  â€”  Analysis Agent v1.0           â•‘',
    modelLine,
    'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
  ];
  banner.forEach(l => appendLine(l, 'line-banner'));
  appendBlank();
  appendLine('  Welcome! Paste a GitHub repository URL to begin analysis.', 'line-dim');
  appendLine('  After the report is generated, ask any question about the codebase.', 'line-dim');
  appendLine('  Type  help  for available commands.', 'line-dim');
  appendBlank();
  appendLine('  Example:  https://github.com/pallets/flask', 'line-dim');
  appendBlank();
}

/* â”€â”€ Session init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function initSession() {
try {
const [sessionRes, configRes] = await Promise.all([
fetch('/api/session/new', { method: 'POST' }),
fetch('/api/config'),
]);
const sessionData = await sessionRes.json();
setSession(sessionData.session_id);

const configData = await configRes.json();
const activeModel = configData.model || '';

// Update the status-bar model label
const modelLabel = document.getElementById('model-label');
if (modelLabel && activeModel) {
modelLabel.textContent = 'model: ' + activeModel;
}

// Store model name globally so printBanner can use it on clear/restart
window._activeModel = activeModel;

setStatus('ready', 'Ready');
return activeModel;
} catch (e) {
setStatus('error', 'Session init failed');
return '';
}
}

/* â”€â”€ GitHub URL validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function isValidGithubUrl(text) {
  // Accepts https://github.com/owner/repo or git@github.com:owner/repo
  return /^(https?:\/\/)?(www\.)?github\.com\/[A-Za-z0-9_.\-]+\/[A-Za-z0-9_.\-]+(\.git)?(\/.*)?$/i.test(text.trim())
      || /^git@github\.com:[A-Za-z0-9_.\-]+\/[A-Za-z0-9_.\-]+(\.git)?$/i.test(text.trim());
}

/* â”€â”€ Pipeline progress panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/**
* Create and insert a pipeline progress panel into #output.
* Returns a controller object with update methods.
*/
function createPipelinePanel() {
const STAGES = [
{ key: 'chunking',  label: 'Chunking',  icon: 'â—ˆ' },
{ key: 'mapping',   label: 'Mapping',   icon: 'âŸ³' },
{ key: 'reducing',  label: 'Reducing',  icon: 'âŠ•' },
];

const panel = document.createElement('div');
panel.className = 'pipeline-panel';

const header = document.createElement('div');
header.className = 'pipeline-header';
header.innerHTML = '<span class="ph-icon">âš™</span> ANALYSIS PIPELINE';
panel.appendChild(header);

const stagesEl = document.createElement('div');
stagesEl.className = 'pipeline-stages';

const stageEls = {};
STAGES.forEach(({ key, label, icon }) => {
const row = document.createElement('div');
row.className = 'pipeline-stage pending';
row.dataset.stage = key;

const iconEl = document.createElement('span');
iconEl.className = 'stage-icon';
iconEl.textContent = icon;

const labelEl = document.createElement('span');
labelEl.className = 'stage-label';
labelEl.textContent = label + '...';

const barWrap = document.createElement('div');
barWrap.className = 'stage-bar-wrap';
const bar = document.createElement('div');
bar.className = 'stage-bar';
bar.style.width = '0%';
barWrap.appendChild(bar);

const detail = document.createElement('span');
detail.className = 'stage-detail';
detail.textContent = 'waiting';

row.appendChild(iconEl);
row.appendChild(labelEl);
row.appendChild(barWrap);
row.appendChild(detail);
stagesEl.appendChild(row);

stageEls[key] = { row, iconEl, labelEl, bar, detail };
});

panel.appendChild(stagesEl);
output.appendChild(panel);
scrollBottom();

return {
/**
* Update a stage's visual state.
* @param {string} key - Stage key: 'chunking'|'mapping'|'reducing'
* @param {'active'|'done'|'pending'} status
* @param {string} detailText - Short detail shown on the right
* @param {number} pct - Progress bar percentage 0-100
*/
update(key, status, detailText, pct) {
const els = stageEls[key];
if (!els) return;
els.row.className = 'pipeline-stage ' + status;
els.detail.textContent = detailText || '';
els.bar.style.width = (pct || 0) + '%';
if (status === 'active') {
els.iconEl.className = 'stage-icon spin';
} else if (status === 'done') {
els.iconEl.className = 'stage-icon';
els.iconEl.textContent = 'âœ“';
} else {
// restore original icon
const orig = STAGES.find(s => s.key === key);
if (orig) els.iconEl.textContent = orig.icon;
els.iconEl.className = 'stage-icon';
}
scrollBottom();
},

/** Mark all remaining pending stages as done (cleanup). */
finishAll() {
STAGES.forEach(({ key }) => {
const els = stageEls[key];
if (els && els.row.classList.contains('active')) {
this.update(key, 'done', 'done', 100);
}
});
},

/** Remove the panel from DOM. */
remove() {
if (panel.parentNode) panel.parentNode.removeChild(panel);
},
};
}

/* â”€â”€ Analyze workflow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function analyzeRepo(url) {
appendBlank();
appendLine('codescope $ ' + url, 'line-prompt');
appendBlank();

setBusy(true);
setStatus('working', 'Cloning & analyzingâ€¦');
promptLabel.textContent = 'working $ ';

const spinnerEl = appendLine('  â ‹ Connecting to GitHubâ€¦', 'line-status');
const spinnerChars = ['â ‹','â ™','â ¹','â ¸','â ¼','â ´','â ¦','â §','â ‡','â '];
let spinIdx = 0;
const spinTimer = setInterval(() => {
if (spinnerEl.parentNode) {
spinnerEl.textContent = '  ' + spinnerChars[spinIdx % spinnerChars.length] + ' ' + spinnerEl.textContent.slice(4);
spinIdx++;
}
}, 100);

// Pipeline panel (created once the analysis phase starts)
let pipelinePanel = null;
// Track per-stage totals for progress bar calculation
const stageTotals = { mapping: 0, reducing: 0 };

try {
const response = await fetch('/api/analyze', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ github_url: url, session_id: state.sessionId }),
});

clearInterval(spinTimer);
removeLine(spinnerEl);

// Handle non-SSE error responses (e.g. 400 validation error)
if (!response.ok && response.headers.get('content-type')?.includes('application/json')) {
const errData = await response.json();
appendErrorHint(errData.error || 'Unknown error from server.');
setBusy(false);
setStatus('error', 'Error');
promptLabel.textContent = 'codescope $ ';
return;
}

const reader = response.body.getReader();
const decoder = new TextDecoder();
let buffer = '';

while (true) {
const { done, value } = await reader.read();
if (done) break;
buffer += decoder.decode(value, { stream: true });

// Parse SSE events
const events = buffer.split('\n\n');
buffer = events.pop(); // keep incomplete last chunk

for (const raw of events) {
if (!raw.trim()) continue;
const lines = raw.split('\n');
let eventType = 'message';
let dataStr = '';
for (const l of lines) {
if (l.startsWith('event: ')) eventType = l.slice(7).trim();
if (l.startsWith('data: '))  dataStr  = l.slice(6).trim();
}
if (!dataStr) continue;

let payload;
try { payload = JSON.parse(dataStr); } catch { continue; }

if (eventType === 'status') {
// Show clone/scan status lines normally; suppress generic analyze line
if (payload.step === 'analyze') {
// Pipeline panel will take over â€” skip generic message
} else {
appendLine(payload.message, 'line-status');
}

} else if (eventType === 'pipeline') {
// Create pipeline panel on first pipeline event
if (!pipelinePanel) {
appendLine('[+] Analyzing codebase with AI...', 'line-status');
pipelinePanel = createPipelinePanel();
}

const stage = payload.stage;

if (stage === 'chunking') {
const total = payload.total_chunks || 1;
stageTotals.mapping = total;
if (total === 1) {
// Single-call strategy â€” mark chunking done immediately
pipelinePanel.update('chunking', 'done', '1 chunk', 100);
} else {
pipelinePanel.update('chunking', 'done', total + ' chunks', 100);
}
setStatus('working', 'Mapping chunksâ€¦');

} else if (stage === 'mapping') {
const chunk = payload.chunk || 0;
const total = payload.total || stageTotals.mapping || 1;
stageTotals.mapping = total;
if (chunk === 0) {
// Launch event
pipelinePanel.update('mapping', 'active', '0 / ' + total, 0);
} else {
const pct = Math.round((chunk / total) * 100);
const isDone = chunk >= total;
pipelinePanel.update(
'mapping',
isDone ? 'done' : 'active',
chunk + ' / ' + total,
pct
);
if (isDone) setStatus('working', 'Reducing summariesâ€¦');
}

} else if (stage === 'reducing') {
const batch = payload.batch || 0;
const totalBatches = payload.total_batches || 1;
const round = payload.round || 1;
stageTotals.reducing = totalBatches;
if (batch === 0) {
// Start of a reduce round
pipelinePanel.update(
'reducing', 'active',
'round ' + round + ': 0/' + totalBatches,
0
);
} else {
const pct = Math.round((batch / totalBatches) * 100);
const isDone = batch >= totalBatches;
pipelinePanel.update(
'reducing',
isDone ? 'done' : 'active',
'round ' + round + ': ' + batch + '/' + totalBatches,
pct
);
}
setStatus('working', 'Reducing summariesâ€¦');
}

} else if (eventType === 'report') {
// Update session id if server assigned one
if (payload.session_id) setSession(payload.session_id);
state.hasReport = true;

// Finish pipeline panel
if (pipelinePanel) {
pipelinePanel.update('reducing', 'done', 'complete', 100);
pipelinePanel.update('mapping', 'done', 'complete', 100);
pipelinePanel.update('chunking', 'done', 'complete', 100);
}

appendBlank();
appendLine('  âœ“ Analysis complete. Report is ready below.', 'line-status');
appendBlank();

// Insert collapsible report block
appendCollapsibleReport(payload.report);

appendBlank();
appendLine('â”€'.repeat(65), 'line-sep');
appendLine('  You can now ask questions about the codebase below.', 'line-status');
appendLine('  Type  restart  or click "â†º New Repo" to analyze a different repository.', 'line-dim');
appendLine('â”€'.repeat(65), 'line-sep');
appendBlank();

// Show the restart button now that a session is active
showRestartButton(true);
// Update placeholder
cmdInput.placeholder = 'Ask a question about the codebaseâ€¦';

} else if (eventType === 'error') {
if (pipelinePanel) pipelinePanel.remove();
appendErrorHint(payload.message);
setStatus('error', 'Error');
}
}
}
} catch (e) {
clearInterval(spinTimer);
removeLine(spinnerEl);
if (pipelinePanel) pipelinePanel.remove();
appendErrorHint('Network error: ' + e.message);
setStatus('error', 'Network error');
}

setBusy(false);
if (statusText.textContent !== 'Error') setStatus('ready', 'Ready');
promptLabel.textContent = 'codescope $ ';
}

/* â”€â”€ QA workflow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function askQuestion(question) {
  appendBlank();
  appendLine('codescope $ ' + question, 'line-question');
  appendBlank();

  setBusy(true);
  setStatus('working', 'Thinkingâ€¦');
  promptLabel.textContent = 'thinking $ ';

  const spinnerEl = appendLine('  â ‹ Querying AIâ€¦', 'line-status');
  const spinnerChars = ['â ‹','â ™','â ¹','â ¸','â ¼','â ´','â ¦','â §','â ‡','â '];
  let spinIdx = 0;
  const spinTimer = setInterval(() => {
    if (spinnerEl.parentNode) {
      spinnerEl.textContent = '  ' + spinnerChars[spinIdx % spinnerChars.length] + ' Querying AIâ€¦';
      spinIdx++;
    }
  }, 100);

  try {
    const res = await fetch('/api/ask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question, session_id: state.sessionId }),
    });

    clearInterval(spinTimer);
    removeLine(spinnerEl);

    const data = await res.json();

    if (!res.ok) {
      appendErrorHint(data.error || 'Unknown error');
    } else {
      appendLine('â”Œâ”€ Agent Response ' + 'â”€'.repeat(47), 'line-label');
      appendBlank();
      renderMarkdown(data.answer, 'line-answer');
      appendBlank();
      appendLine('â””' + 'â”€'.repeat(64), 'line-label');
      appendBlank();
    }
  } catch (e) {
    clearInterval(spinTimer);
    removeLine(spinnerEl);
    appendErrorHint('Network error: ' + e.message);
  }

  setBusy(false);
  setStatus('ready', 'Ready');
  promptLabel.textContent = 'codescope $ ';
}

/* â”€â”€ Restart workflow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function doRestart() {
  if (state.busy) return;

  setBusy(true);
  setStatus('working', 'Restartingâ€¦');

  try {
    const res = await fetch('/api/restart', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_id: state.sessionId }),
    });
    const data = await res.json();

    // Clear terminal and reset state
    output.innerHTML = '';
    state.hasReport = false;
    setSession(data.session_id);
    showRestartButton(false);
    cmdInput.placeholder = 'Enter a GitHub URL to beginâ€¦';

    printBanner(window._activeModel);
    appendLine('  âœ“ Session restarted. Ready for a new GitHub URL.', 'line-status');
    appendBlank();

    setStatus('ready', 'Ready');
  } catch (e) {
    appendErrorHint('Restart failed: ' + e.message);
    setStatus('error', 'Error');
  }

  setBusy(false);
  promptLabel.textContent = 'codescope $ ';
  cmdInput.focus();
}

/* â”€â”€ Built-in commands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function handleBuiltIn(cmd) {
  const lower = cmd.trim().toLowerCase();

  if (lower === 'clear' || lower === 'cls') {
    output.innerHTML = '';
    printBanner(window._activeModel);
    return true;
  }

  if (lower === 'help') {
    appendBlank();
    appendLine('  Available commands:', 'line-label');
    appendLine('  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'line-sep');
    appendLine('  <github-url>   Analyze a GitHub repository', 'line-dim');
    appendLine('  <question>     Ask a follow-up question (after analysis)', 'line-dim');
    appendLine('  restart        Start over with a new GitHub URL', 'line-dim');
    appendLine('  clear / cls    Clear the terminal display', 'line-dim');
    appendLine('  help           Show this help message', 'line-dim');
    appendBlank();
    return true;
  }

  if (lower === 'restart' || lower === 'reset' || lower === 'new') {
    await doRestart();
    return true;
  }

  return false;
}

/* â”€â”€ Main submit handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function handleSubmit() {
  const raw = cmdInput.value.trim();
  if (!raw || state.busy) return;

  // Save to history
  state.history.unshift(raw);
  if (state.history.length > 50) state.history.pop();
  state.historyIdx = -1;
  cmdInput.value = '';

  // Built-in commands take priority
  if (await handleBuiltIn(raw)) return;

  // â”€â”€ No active session (no report yet) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (!state.hasReport) {
    // Must be a valid GitHub URL
    if (!isValidGithubUrl(raw)) {
      appendBlank();
      appendLine('codescope $ ' + raw, 'line-prompt');
      appendBlank();
      appendErrorHint(
        'No repository loaded yet. Please enter a valid GitHub URL to begin.\n' +
        'Example: https://github.com/pallets/flask'
      );
      appendBlank();
      return;
    }
    // Valid URL â†’ analyze
    await analyzeRepo(raw);
    return;
  }

  // â”€â”€ Active session: accept questions only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // If user pastes a new GitHub URL while a session is active, offer restart hint
  if (isValidGithubUrl(raw)) {
    appendBlank();
    appendLine('codescope $ ' + raw, 'line-prompt');
    appendBlank();
    appendErrorHint(
      'A repository is already loaded. To analyze a new URL, type  restart  first\n' +
      'or click the "â†º New Repo" button in the title bar.'
    );
    appendBlank();
    return;
  }

  // Regular question
  await askQuestion(raw);
}

/* â”€â”€ Keyboard handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
cmdInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    handleSubmit();
    return;
  }
  // History navigation
  if (e.key === 'ArrowUp') {
    e.preventDefault();
    if (state.historyIdx < state.history.length - 1) {
      state.historyIdx++;
      cmdInput.value = state.history[state.historyIdx];
    }
  }
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    if (state.historyIdx > 0) {
      state.historyIdx--;
      cmdInput.value = state.history[state.historyIdx];
    } else {
      state.historyIdx = -1;
      cmdInput.value = '';
    }
  }
});

btnSubmit.addEventListener('click', handleSubmit);
btnRestart.addEventListener('click', doRestart);

/* â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(async () => {
  setStatus('working', 'Initializingâ€¦');
  // Fetch model name first, then print banner with it
  const activeModel = await initSession();
  printBanner(activeModel || window._activeModel);
  setStatus('ready', 'Ready');
  cmdInput.focus();
})();
</script>
</body>
</html>